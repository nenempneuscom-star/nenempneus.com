generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// LOJAS (Multi-tenant core)
// ============================================
model Loja {
  id        String   @id @default(uuid())
  slug      String   @unique
  nome      String
  cnpj      String?
  
  email     String?
  telefone  String?
  whatsapp  String?
  
  endereco  String?
  cidade    String?
  estado    String?
  cep       String?
  
  logoUrl       String?   @map("logo_url")
  corPrimaria   String    @default("#FF6B00") @map("cor_primaria")
  corSecundaria String    @default("#1A1A1A") @map("cor_secundaria")
  
  ativo     Boolean  @default(true)
  plano     String   @default("basico")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  usuarios     Usuario[]
  produtos     Produto[]
  categorias   Categoria[]
  pedidos      Pedido[]
  agendamentos Agendamento[]
  clientes     Cliente[]
  conversas    ConversaWhatsApp[]
  avaliacoes   Avaliacao[]
  settings     Settings?

  @@map("lojas")
}

// ============================================
// USUÁRIOS (Admin da loja)
// ============================================
model Usuario {
  id       String   @id @default(uuid())
  lojaId   String   @map("loja_id")
  loja     Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  nome        String
  email       String   @unique
  senhaHash   String   @map("senha_hash")
  
  role        String   @default("admin")
  ativo       Boolean  @default(true)
  ultimoLogin DateTime? @map("ultimo_login")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([lojaId])
  @@map("usuarios")
}

// ============================================
// CLIENTES
// ============================================
model Cliente {
  id       String @id @default(uuid())
  lojaId   String @map("loja_id")
  loja     Loja   @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  nome     String
  email    String?
  telefone String?
  cpf      String?
  
  veiculoMarca  String? @map("veiculo_marca")
  veiculoModelo String? @map("veiculo_modelo")
  veiculoAno    Int?    @map("veiculo_ano")
  veiculoPlaca  String? @map("veiculo_placa")
  
  totalCompras Int      @default(0) @map("total_compras")
  valorTotal   Decimal  @default(0) @db.Decimal(10, 2) @map("valor_total")
  ultimaCompra DateTime? @map("ultima_compra")
  
  tags Json @default("[]")
  
  aceitaMarketing Boolean @default(false) @map("aceita_marketing")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  pedidos      Pedido[]
  agendamentos Agendamento[]
  avaliacoes   Avaliacao[]

  @@index([lojaId])
  @@index([telefone])
  @@map("clientes")
}

// ============================================
// CATEGORIAS
// ============================================
model Categoria {
  id        String   @id @default(uuid())
  lojaId    String   @map("loja_id")
  loja      Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  nome      String
  slug      String
  descricao String?
  ativo     Boolean  @default(true)
  ordem     Int      @default(0)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  produtos Produto[]

  @@unique([lojaId, slug])
  @@index([lojaId])
  @@map("categorias")
}

// ============================================
// PRODUTOS
// ============================================
model Produto {
  id          String    @id @default(uuid())
  lojaId      String    @map("loja_id")
  loja        Loja      @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  categoriaId String    @map("categoria_id")
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  
  nome      String
  slug      String
  descricao String?
  preco     Decimal   @db.Decimal(10, 2)
  estoque   Int       @default(0)
  
  imagemUrl String? @map("imagem_url")
  
  specs    Json @default("{}")
  veiculos Json @default("[]")
  
  ativo    Boolean @default(true)
  destaque Boolean @default(false)
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  pedidoItems PedidoItem[]

  @@unique([lojaId, slug])
  @@index([lojaId])
  @@index([categoriaId])
  @@map("produtos")
}

// ============================================
// PEDIDOS
// ============================================
model Pedido {
  id        String   @id @default(uuid())
  lojaId    String   @map("loja_id")
  loja      Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  clienteId String   @map("cliente_id")
  cliente   Cliente  @relation(fields: [clienteId], references: [id])
  
  numero  String  @unique
  
  subtotal Decimal @db.Decimal(10, 2)
  desconto Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)
  
  status         String  @default("pendente")
  temAgendamento Boolean @default(false) @map("tem_agendamento")
  
  observacoes String?
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  items       PedidoItem[]
  pagamentos  Pagamento[]
  agendamento Agendamento?

  @@index([lojaId])
  @@index([clienteId])
  @@index([status])
  @@map("pedidos")
}

model PedidoItem {
  id        String  @id @default(uuid())
  pedidoId  String  @map("pedido_id")
  pedido    Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  produtoId String  @map("produto_id")
  produto   Produto @relation(fields: [produtoId], references: [id])
  
  quantidade Int
  precoUnit  Decimal @db.Decimal(10, 2) @map("preco_unit")
  subtotal   Decimal @db.Decimal(10, 2)
  
  createdAt DateTime @default(now()) @map("created_at")

  @@index([pedidoId])
  @@index([produtoId])
  @@map("pedido_items")
}

// ============================================
// PAGAMENTOS
// ============================================
model Pagamento {
  id       String  @id @default(uuid())
  pedidoId String  @map("pedido_id")
  pedido   Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  gateway String
  metodo  String
  status  String  @default("pendente")
  valor   Decimal @db.Decimal(10, 2)
  
  mpPreferenceId String? @map("mp_preference_id")
  mpPaymentId    String? @map("mp_payment_id")
  mpStatus       String? @map("mp_status")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([pedidoId])
  @@index([mpPaymentId])
  @@map("pagamentos")
}

// ============================================
// AGENDAMENTOS
// ============================================
model Agendamento {
  id       String  @id @default(uuid())
  lojaId   String  @map("loja_id")
  loja     Loja    @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  pedidoId String  @unique @map("pedido_id")
  pedido   Pedido  @relation(fields: [pedidoId], references: [id])
  clienteId String @map("cliente_id")
  cliente   Cliente @relation(fields: [clienteId], references: [id])
  
  data DateTime @db.Date
  hora DateTime @db.Time
  
  status           String  @default("confirmado")
  lembreteEnviado  Boolean @default(false) @map("lembrete_enviado")
  observacoes      String?
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([lojaId, data, hora, status], name: "unique_slot")
  @@index([lojaId])
  @@index([clienteId])
  @@index([data, hora])
  @@map("agendamentos")
}

// ============================================
// WHATSAPP
// ============================================
model ConversaWhatsApp {
  id       String @id @default(uuid())
  lojaId   String @map("loja_id")
  loja     Loja   @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  telefone     String
  nomeContato  String? @map("nome_contato")
  
  status           String   @default("ativa")
  modo             String   @default("bot")
  totalMensagens   Int      @default(0) @map("total_mensagens")
  ultimaMensagemEm DateTime? @map("ultima_mensagem_em")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  mensagens MensagemWhatsApp[]

  @@unique([lojaId, telefone])
  @@index([lojaId])
  @@index([telefone])
  @@map("conversas_whatsapp")
}

model MensagemWhatsApp {
  id          String            @id @default(uuid())
  conversaId  String            @map("conversa_id")
  conversa    ConversaWhatsApp  @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  
  direcao   String
  remetente String?
  conteudo  String @db.Text
  
  waMessageId     String? @unique @map("wa_message_id")
  processadoPorIa Boolean @default(false) @map("processado_por_ia")
  
  createdAt DateTime @default(now()) @map("created_at")

  @@index([conversaId])
  @@index([waMessageId])
  @@map("mensagens_whatsapp")
}

// ============================================
// AVALIAÇÕES
// ============================================
model Avaliacao {
  id        String  @id @default(uuid())
  lojaId    String  @map("loja_id")
  loja      Loja    @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  clienteId String  @map("cliente_id")
  cliente   Cliente @relation(fields: [clienteId], references: [id])
  
  nota       Int
  comentario String?
  aprovado   Boolean @default(true)
  
  createdAt DateTime @default(now()) @map("created_at")

  @@index([lojaId])
  @@index([clienteId])
  @@map("avaliacoes")
}

// ============================================
// SETTINGS (Configurações por loja)
// ============================================
model Settings {
  id     String @id @default(uuid())
  lojaId String @unique @map("loja_id")
  loja   Loja   @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  
  // Agendamentos
  horarioInicio     DateTime @default(dbgenerated("'08:00:00'::time")) @db.Time @map("horario_inicio")
  horarioFim        DateTime @default(dbgenerated("'18:00:00'::time")) @db.Time @map("horario_fim")
  intervaloSlots    Int      @default(60) @map("intervalo_slots")
  clientesPorSlot   Int      @default(2) @map("clientes_por_slot")
  diasFuncionamento Json     @default("[1,2,3,4,5,6]") @map("dias_funcionamento")
  
  // Pagamentos
  formasPagamento Json    @default("[\"pix\",\"cartao\"]") @map("formas_pagamento")
  modoPagamento   String  @default("hibrido") @map("modo_pagamento")
  descontoPix     Decimal @default(5) @db.Decimal(5, 2) @map("desconto_pix")
  
  // WhatsApp Bot
  modoBot          String  @default("comercial") @map("modo_bot")
  botAtivo         Boolean @default(true) @map("bot_ativo")
  palavrasHumano   Json    @default("[\"atendente\",\"humano\"]") @map("palavras_humano")
  
  // Notificações
  notifWhatsapp Boolean @default(true) @map("notif_whatsapp")
  notifEmail    Boolean @default(true) @map("notif_email")
  lembreteHoras Int     @default(24) @map("lembrete_horas")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
