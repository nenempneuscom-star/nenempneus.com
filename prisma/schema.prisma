generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Loja {
  id            String             @id @default(uuid())
  slug          String             @unique
  nome          String
  cnpj          String?
  email         String?
  telefone      String?
  whatsapp      String?
  endereco      String?
  cidade        String?
  estado        String?
  cep           String?
  logoUrl       String?            @map("logo_url")
  corPrimaria   String             @default("#FF6B00") @map("cor_primaria")
  corSecundaria String             @default("#1A1A1A") @map("cor_secundaria")
  ativo         Boolean            @default(true)
  plano         String             @default("basico")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  agendamentos  Agendamento[]
  avaliacoes    Avaliacao[]
  categorias    Categoria[]
  clientes      Cliente[]
  conversas     ConversaWhatsApp[]
  pedidos       Pedido[]
  produtos      Produto[]
  settings      Settings?
  usuarios      Usuario[]
  cupons        Cupom[]

  @@map("lojas")
}

model Usuario {
  id          String    @id @default(uuid())
  lojaId      String    @map("loja_id")
  nome        String
  email       String    @unique
  senhaHash   String    @map("senha_hash")
  role        String    @default("admin")
  permissoes  Json      @default("{\"dashboard\":true,\"produtos\":true,\"pedidos\":true,\"agendamentos\":true,\"whatsapp\":true,\"configuracoes\":false,\"usuarios\":false}")
  ativo       Boolean   @default(true)
  ultimoLogin DateTime? @map("ultimo_login")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  loja        Loja      @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  @@index([lojaId])
  @@map("usuarios")
}

model Cliente {
  id                  String        @id @default(uuid())
  lojaId              String        @map("loja_id")
  nome                String
  email               String?
  telefone            String?
  cpf                 String?
  // Campos legados de veiculo (mantidos por compatibilidade)
  veiculoMarca        String?       @map("veiculo_marca")
  veiculoModelo       String?       @map("veiculo_modelo")
  veiculoAno          Int?          @map("veiculo_ano")
  veiculoPlaca        String?       @map("veiculo_placa")
  // Estatisticas
  totalCompras        Int           @default(0) @map("total_compras")
  valorTotal          Decimal       @default(0) @map("valor_total") @db.Decimal(10, 2)
  ultimaCompra        DateTime?     @map("ultima_compra")
  tags                Json          @default("[]")
  aceitaMarketing     Boolean       @default(false) @map("aceita_marketing")
  // Autenticacao por codigo
  codigoVerificacao   String?       @map("codigo_verificacao")
  codigoExpiraEm      DateTime?     @map("codigo_expira_em")
  // Fidelidade
  pontos              Int           @default(0)
  // Notificacoes
  notifWhatsapp       Boolean       @default(true) @map("notif_whatsapp")
  notifEmail          Boolean       @default(false) @map("notif_email")
  notifPromocoes      Boolean       @default(true) @map("notif_promocoes")
  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  // Relations
  agendamentos        Agendamento[]
  avaliacoes          Avaliacao[]
  loja                Loja          @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  pedidos             Pedido[]
  veiculos            Veiculo[]
  favoritos           Favorito[]
  cuponsUsados        CupomUso[]
  indicacoes          Indicacao[]   @relation("indicador")
  indicadoPor         Indicacao?    @relation("indicado")

  @@index([lojaId])
  @@index([telefone])
  @@map("clientes")
}

model Categoria {
  id        String    @id @default(uuid())
  lojaId    String    @map("loja_id")
  nome      String
  slug      String
  descricao String?
  ativo     Boolean   @default(true)
  ordem     Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")
  loja      Loja      @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  produtos  Produto[]

  @@unique([lojaId, slug])
  @@index([lojaId])
  @@map("categorias")
}

model Produto {
  id          String       @id @default(uuid())
  lojaId      String       @map("loja_id")
  categoriaId String       @map("categoria_id")
  nome        String
  slug        String
  descricao   String?
  preco       Decimal      @db.Decimal(10, 2)
  estoque     Int          @default(0)
  imagemUrl   String?      @map("imagem_url")
  specs       Json         @default("{}")
  veiculos    Json         @default("[]")
  ativo       Boolean      @default(true)
  destaque    Boolean      @default(false)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  pedidoItems PedidoItem[]
  categoria   Categoria    @relation(fields: [categoriaId], references: [id])
  loja        Loja         @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  favoritos   Favorito[]

  @@unique([lojaId, slug])
  @@index([lojaId])
  @@index([categoriaId])
  @@map("produtos")
}

model Pedido {
  id             String       @id @default(uuid())
  lojaId         String       @map("loja_id")
  clienteId      String       @map("cliente_id")
  numero         String       @unique
  subtotal       Decimal      @db.Decimal(10, 2)
  desconto       Decimal      @default(0) @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  status         String       @default("pendente")
  temAgendamento Boolean      @default(false) @map("tem_agendamento")
  observacoes    String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  agendamento    Agendamento?
  pagamentos     Pagamento[]
  items          PedidoItem[]
  cliente        Cliente      @relation(fields: [clienteId], references: [id])
  loja           Loja         @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  @@index([lojaId])
  @@index([clienteId])
  @@index([status])
  @@map("pedidos")
}

model PedidoItem {
  id         String   @id @default(uuid())
  pedidoId   String   @map("pedido_id")
  produtoId  String   @map("produto_id")
  quantidade Int
  precoUnit  Decimal  @map("preco_unit") @db.Decimal(10, 2)
  subtotal   Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  pedido     Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  produto    Produto  @relation(fields: [produtoId], references: [id])

  @@index([pedidoId])
  @@index([produtoId])
  @@map("pedido_items")
}

model Pagamento {
  id             String   @id @default(uuid())
  pedidoId       String   @map("pedido_id")
  gateway        String
  metodo         String
  status         String   @default("pendente")
  valor          Decimal  @db.Decimal(10, 2)
  mpPreferenceId String?  @map("mp_preference_id")
  mpPaymentId    String?  @map("mp_payment_id")
  mpStatus       String?  @map("mp_status")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  pedido         Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([pedidoId])
  @@index([mpPaymentId])
  @@map("pagamentos")
}

model Agendamento {
  id              String   @id @default(uuid())
  lojaId          String   @map("loja_id")
  pedidoId        String   @unique @map("pedido_id")
  clienteId       String   @map("cliente_id")
  data            DateTime @db.Date
  hora            DateTime @db.Time(6)
  status          String   @default("confirmado")
  lembreteEnviado Boolean  @default(false) @map("lembrete_enviado")
  observacoes     String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  cliente         Cliente  @relation(fields: [clienteId], references: [id])
  loja            Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  pedido          Pedido   @relation(fields: [pedidoId], references: [id])

  @@index([lojaId])
  @@index([clienteId])
  @@index([data, hora])
  @@map("agendamentos")
}

model ConversaWhatsApp {
  id               String             @id @default(uuid())
  lojaId           String             @map("loja_id")
  telefone         String
  nomeContato      String?            @map("nome_contato")
  status           String             @default("ativa")
  modo             String             @default("bot")
  totalMensagens   Int                @default(0) @map("total_mensagens")
  ultimaMensagemEm DateTime?          @map("ultima_mensagem_em")
  // Campos de Lead/Funil de Vendas
  etapaFunil       String             @default("novo") @map("etapa_funil") // novo, qualificando, orcamento, negociando, fechando, convertido, perdido
  pontuacaoLead    Int                @default(0) @map("pontuacao_lead") // 0-100
  valorPotencial   Decimal?           @map("valor_potencial") @db.Decimal(10, 2)
  motivoPerda      String?            @map("motivo_perda")
  veiculoInfo      Json?              @map("veiculo_info") // { marca, modelo, ano, medida }
  tags             Json               @default("[]")
  anotacoes        String?
  proximoFollowUp  DateTime?          @map("proximo_follow_up")
  // Timestamps
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  // Relations
  loja             Loja               @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  mensagens        MensagemWhatsApp[]
  metricas         MetricaConversa[]

  @@unique([lojaId, telefone])
  @@index([lojaId])
  @@index([telefone])
  @@index([etapaFunil])
  @@map("conversas_whatsapp")
}

model MensagemWhatsApp {
  id              String           @id @default(uuid())
  conversaId      String           @map("conversa_id")
  direcao         String
  remetente       String?
  conteudo        String
  waMessageId     String?          @unique @map("wa_message_id")
  processadoPorIa Boolean          @default(false) @map("processado_por_ia")
  createdAt       DateTime         @default(now()) @map("created_at")
  conversa        ConversaWhatsApp @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@index([conversaId])
  @@index([waMessageId])
  @@map("mensagens_whatsapp")
}

model Avaliacao {
  id         String   @id @default(uuid())
  lojaId     String   @map("loja_id")
  clienteId  String   @map("cliente_id")
  nota       Int
  comentario String?
  aprovado   Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  cliente    Cliente  @relation(fields: [clienteId], references: [id])
  loja       Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  @@index([lojaId])
  @@index([clienteId])
  @@map("avaliacoes")
}

model Settings {
  id                String   @id @default(uuid())
  lojaId            String   @unique @map("loja_id")
  horarioInicio     DateTime @default(dbgenerated("'08:00:00'::time without time zone")) @map("horario_inicio") @db.Time(6)
  horarioFim        DateTime @default(dbgenerated("'18:00:00'::time without time zone")) @map("horario_fim") @db.Time(6)
  intervaloSlots    Int      @default(60) @map("intervalo_slots")
  clientesPorSlot   Int      @default(2) @map("clientes_por_slot")
  diasFuncionamento Json     @default("[1, 2, 3, 4, 5, 6]") @map("dias_funcionamento")
  // Horários específicos por dia da semana (JSON: { "0": { "inicio": "08:00", "fim": "12:00" }, "1": { "inicio": "08:00", "fim": "18:00" }, ... })
  horariosPorDia    Json?    @map("horarios_por_dia")
  intervaloAtivo    Boolean  @default(false) @map("intervalo_ativo")
  intervaloInicio   DateTime @default(dbgenerated("'12:00:00'::time without time zone")) @map("intervalo_inicio") @db.Time(6)
  intervaloFim      DateTime @default(dbgenerated("'13:00:00'::time without time zone")) @map("intervalo_fim") @db.Time(6)
  formasPagamento   Json     @default("[\"pix\", \"cartao\"]") @map("formas_pagamento")
  modoPagamento     String   @default("hibrido") @map("modo_pagamento")
  descontoPix       Decimal  @default(5) @map("desconto_pix") @db.Decimal(5, 2)
  parcelasMaximas   Int      @default(12) @map("parcelas_maximas")
  taxaJuros         Decimal  @default(0) @map("taxa_juros") @db.Decimal(5, 2)
  modoBot           String   @default("comercial") @map("modo_bot")
  botAtivo          Boolean  @default(true) @map("bot_ativo")
  palavrasHumano    Json     @default("[\"atendente\", \"humano\"]") @map("palavras_humano")
  notifWhatsapp     Boolean  @default(true) @map("notif_whatsapp")
  notifEmail        Boolean  @default(true) @map("notif_email")
  lembreteHoras     Int      @default(24) @map("lembrete_horas")
  featureFlags      Json     @default("{\"importacaoEmMassa\":false,\"exportacaoRelatorios\":true,\"notificacoesWhatsapp\":true}") @map("feature_flags")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  loja              Loja     @relation(fields: [lojaId], references: [id], onDelete: Cascade)

  @@map("settings")
}

// ==========================================
// AREA DO CLIENTE - Novos Models
// ==========================================

model Veiculo {
  id        String   @id @default(uuid())
  clienteId String   @map("cliente_id")
  apelido   String?  // Ex: "Meu Carro", "Carro da Esposa"
  marca     String
  modelo    String
  ano       Int?
  placa     String?
  cor       String?
  principal Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@map("veiculos")
}

model Favorito {
  id        String   @id @default(uuid())
  clienteId String   @map("cliente_id")
  produtoId String   @map("produto_id")
  createdAt DateTime @default(now()) @map("created_at")
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  produto   Produto  @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([clienteId, produtoId])
  @@index([clienteId])
  @@index([produtoId])
  @@map("favoritos")
}

model Cupom {
  id              String     @id @default(uuid())
  lojaId          String     @map("loja_id")
  codigo          String
  descricao       String?
  tipo            String     @default("percentual") // percentual, fixo
  valor           Decimal    @db.Decimal(10, 2)
  minimo          Decimal?   @db.Decimal(10, 2) // valor minimo do pedido
  usoMaximo       Int?       @map("uso_maximo") // quantas vezes pode ser usado no total
  usoPorCliente   Int        @default(1) @map("uso_por_cliente") // quantas vezes por cliente
  usosRealizados  Int        @default(0) @map("usos_realizados")
  ativo           Boolean    @default(true)
  validoAte       DateTime?  @map("valido_ate")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  loja            Loja       @relation(fields: [lojaId], references: [id], onDelete: Cascade)
  usos            CupomUso[]

  @@unique([lojaId, codigo])
  @@index([lojaId])
  @@index([codigo])
  @@map("cupons")
}

model CupomUso {
  id        String   @id @default(uuid())
  cupomId   String   @map("cupom_id")
  clienteId String   @map("cliente_id")
  pedidoId  String?  @map("pedido_id")
  valor     Decimal  @db.Decimal(10, 2) // valor do desconto aplicado
  createdAt DateTime @default(now()) @map("created_at")
  cupom     Cupom    @relation(fields: [cupomId], references: [id], onDelete: Cascade)
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([cupomId])
  @@index([clienteId])
  @@map("cupom_usos")
}

model Indicacao {
  id           String   @id @default(uuid())
  lojaId       String   @map("loja_id")
  indicadorId  String   @map("indicador_id")
  indicadoId   String   @unique @map("indicado_id")
  codigo       String   // codigo usado na indicacao
  bonus        Decimal? @db.Decimal(10, 2) // bonus dado ao indicador
  bonusUsado   Boolean  @default(false) @map("bonus_usado")
  createdAt    DateTime @default(now()) @map("created_at")
  indicador    Cliente  @relation("indicador", fields: [indicadorId], references: [id])
  indicado     Cliente  @relation("indicado", fields: [indicadoId], references: [id])

  @@index([lojaId])
  @@index([indicadorId])
  @@map("indicacoes")
}

model AlertaPreco {
  id          String   @id @default(uuid())
  clienteId   String   @map("cliente_id")
  produtoId   String   @map("produto_id")
  precoAlvo   Decimal  @map("preco_alvo") @db.Decimal(10, 2)
  notificado  Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([clienteId, produtoId])
  @@index([clienteId])
  @@index([produtoId])
  @@map("alertas_preco")
}

// ==========================================
// FIM - Area do Cliente
// ==========================================

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model analytics {
  id                              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projeto_id                      String
  total_prompts_gerados           Int?      @default(0)
  total_refinamentos              Int?      @default(0)
  total_tokens_usados             Int?      @default(0)
  taxa_sucesso_primeira_tentativa Float?    @default(0)
  tempo_medio_resolucao_minutos   Int?      @default(0)
  created_at                      DateTime? @default(now()) @db.Timestamp(6)
  updated_at                      DateTime? @default(now()) @db.Timestamp(6)

  @@index([projeto_id], map: "idx_analytics_projeto")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model refinamentos {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projeto_id        String
  problema_original String
  prompt_original   String
  prompt_refinado   String
  tipo_refinamento  String
  resolvido         Boolean?
  tokens_usados     Int?
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)

  @@index([projeto_id], map: "idx_refinamentos_projeto")
  @@index([resolvido], map: "idx_refinamentos_resolvido")
  @@index([tipo_refinamento], map: "idx_refinamentos_tipo")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model solucoes_efetivas {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projeto_id       String
  tipo_problema    String
  contexto         String
  solucao          String
  tipo_refinamento String?
  vezes_usado      Int?      @default(1)
  taxa_sucesso     Float?    @default(100)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)

  @@index([projeto_id], map: "idx_solucoes_projeto")
  @@index([tipo_problema], map: "idx_solucoes_tipo")
}

// ==========================================
// METRICAS WHATSAPP SALES
// ==========================================

model MetricaConversa {
  id              String           @id @default(uuid())
  conversaId      String           @map("conversa_id")
  // Eventos
  evento          String           // mensagem_recebida, mensagem_enviada, lead_qualificado, orcamento_enviado, link_checkout, conversao, perda
  dados           Json?            // dados extras do evento
  // Timestamps
  createdAt       DateTime         @default(now()) @map("created_at")
  // Relations
  conversa        ConversaWhatsApp @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@index([conversaId])
  @@index([evento])
  @@index([createdAt])
  @@map("metricas_conversa")
}

model MetricaWhatsAppDiaria {
  id                    String   @id @default(uuid())
  lojaId                String   @map("loja_id")
  data                  DateTime @db.Date
  // Conversas
  totalConversas        Int      @default(0) @map("total_conversas")
  conversasNovas        Int      @default(0) @map("conversas_novas")
  conversasAtivas       Int      @default(0) @map("conversas_ativas")
  // Mensagens
  totalMensagens        Int      @default(0) @map("total_mensagens")
  mensagensEntrada      Int      @default(0) @map("mensagens_entrada")
  mensagensSaida        Int      @default(0) @map("mensagens_saida")
  mensagensBot          Int      @default(0) @map("mensagens_bot")
  mensagensHumano       Int      @default(0) @map("mensagens_humano")
  // Funil
  leadsNovos            Int      @default(0) @map("leads_novos")
  leadsQualificados     Int      @default(0) @map("leads_qualificados")
  orcamentosEnviados    Int      @default(0) @map("orcamentos_enviados")
  linksCheckoutEnviados Int      @default(0) @map("links_checkout_enviados")
  conversoes            Int      @default(0)
  perdas                Int      @default(0)
  // Valores
  valorPotencialTotal   Decimal  @default(0) @map("valor_potencial_total") @db.Decimal(10, 2)
  valorConvertido       Decimal  @default(0) @map("valor_convertido") @db.Decimal(10, 2)
  // Performance
  tempoMedioResposta    Int?     @map("tempo_medio_resposta") // em segundos
  taxaConversao         Decimal? @map("taxa_conversao") @db.Decimal(5, 2)
  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@unique([lojaId, data])
  @@index([lojaId])
  @@index([data])
  @@map("metricas_whatsapp_diaria")
}

model FollowUpAgendado {
  id          String           @id @default(uuid())
  conversaId  String           @map("conversa_id")
  tipo        String           // orcamento, carrinho_abandonado, pos_venda, reengajamento
  mensagem    String?
  agendadoPara DateTime        @map("agendado_para")
  enviado     Boolean          @default(false)
  enviadoEm   DateTime?        @map("enviado_em")
  cancelado   Boolean          @default(false)
  createdAt   DateTime         @default(now()) @map("created_at")

  @@index([conversaId])
  @@index([agendadoPara])
  @@index([enviado])
  @@map("follow_ups_agendados")
}

model FeedbackIA {
  id          String   @id @default(uuid())
  conversaId  String   @map("conversa_id")
  mensagemId  String   @map("mensagem_id")
  tipo        String   // positivo, negativo, correcao
  feedback    String?
  correcao    String?  // resposta correta sugerida
  usuarioId   String?  @map("usuario_id") // admin que deu feedback
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([conversaId])
  @@index([tipo])
  @@map("feedbacks_ia")
}
